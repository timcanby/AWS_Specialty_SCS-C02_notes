# AWS Lambda × S3 サーバーレス画像処理システムの安全設計

## 📘 Scenario（シナリオ）

企業が、**AWS Lambda 関数を使用して大きな画像からサムネイル画像を生成**するシステムを構築しています。  
Lambda 関数は、**同一 AWS アカウント内の S3 バケットにアクセス**し、元画像を読み込み、生成されたサムネイルを保存します。

この構成は、**S3 のアップロードイベントによって Lambda をトリガーし、処理結果を再び S3 に保存する**という、典型的な AWS のイベント駆動型サーバーレスアーキテクチャです。

このような場合、**Lambda が S3 にアクセスするための適切で安全な認可設定**が重要なポイントとなります。

---

## 🎯 Test Points（考察ポイント）

- Lambda から S3 への安全なアクセス権限の設定方法
- IAM の基本理解（IAM ユーザー、IAM ロール、IAM ポリシーの違いと適用）
- S3 バケットポリシーの仕組みと IAM ポリシーとの連携
- 長期クレデンシャルを避ける AWS のセキュリティベストプラクティス
- IAM/バケットポリシー と Security Group などのネットワーク制御の違いの理解

---

## 🧠 Related Knowledge（関連知識）

### IAM ユーザー vs. IAM ロール

- IAM ユーザーは人間またはアプリケーション向けで、静的なアクセスキーを持つ。
- IAM ロールは AWS サービス（Lambda、EC2 など）に一時的なクレデンシャルを提供し、**サービス間のアクセスに最適**。
- Lambda には IAM ロールを割り当てることで、他の AWS サービス（例：S3）へのアクセスを安全に許可可能。

### IAM ポリシー

- IAM ポリシーは「どの操作を、どのリソースに対して許可するか」を定義する文書。
- IAM ロールにアタッチされたポリシーによって、Lambda が `s3:GetObject` や `s3:PutObject` などの操作を実行可能にする。

### S3 バケットポリシー

- S3 に直接設定できるリソースベースのポリシー。
- IAM ロールを Principal として明示的に許可することで、Lambda 側での IAM 設定とは別にバケット側からアクセスを管理可能。
- IAM ポリシーと併用することで、アクセス制御の粒度を細かく調整できる。

### AWS Secrets Manager（参考）

- パスワードや API キーなどの機密情報を安全に管理するためのサービス。
- **EC2 キーペアを保存して S3 にアクセスする用途では適切でない**。

### EC2 Key Pair

- SSH で EC2 にログインするための認証情報。
- **S3 API へのアクセスには使用されない**。

### Security Group

- ネットワークレベル（L3/L4）でのアクセス制御（IP/ポート単位）。
- **S3 の API アクセス権限には関与せず、IAM やバケットポリシーで制御する必要がある**。

---

## ✅ Summary（まとめ）

このシナリオは、サーバーレスアーキテクチャにおける代表的なデータ処理パターンであり、  
**Lambda が S3 に安全かつ確実にアクセスするための適切な IAM 設計が問われるケース**です。

### 推奨されるアプローチ

- ✅ Lambda に IAM ロールを割り当て、そのロールに S3 アクセス権限を付与（IAM ポリシー使用）
- ✅ S3 バケットにバケットポリシーを設定し、Lambda の IAM ロールを Principal としてアクセス許可

### 避けるべきアプローチ

- ❌ IAM ユーザーのアクセスキーを Lambda に埋め込む（長期クレデンシャルの使用）
- ❌ Secrets Manager に EC2 キーペアを保存して S3 アクセスに使用
- ❌ Security Group による S3 アクセス制御の誤用

Lambda と S3 の統合においては、**IAM ロールを中心に設計するのが AWS のベストプラクティス**です。


## IAMロールにおける「信頼ポリシー」と「権限ポリシー」の違い

| 種類             | 対象             | 内容の役割                                      | 誰がこのロールを引き受けられるか       | このロールは何ができるか               |
|------------------|------------------|--------------------------------------------------|----------------------------------------|----------------------------------------|
| **信頼ポリシー** | IAMロール自身     | **どのサービス/ユーザーがこのロールを引き受けられるか**を定義 | ✅ 例：Lambdaサービスがロールを引き受ける | ❌ リソースへのアクセス権限は含まない     |
| **権限ポリシー** | IAMロール自身     | **このロールがどのAWSリソースに何の操作ができるか**を定義     | ❌ 引き受ける相手は制御しない             | ✅ 例：S3バケットの読み書き、ログ出力など |

### 💡 イメージで理解する

- **信頼ポリシー**：このロールを「誰が着る（Assume）ことができるか」の設定（＝ユニフォームの貸出対象）
- **権限ポリシー**：このロールを着た人が「何ができるか」の設定（＝社員証のアクセス範囲）

---

### 例：Lambdaの実行ロールの場合

- 信頼ポリシーで `lambda.amazonaws.com` に引き受けを許可
- 権限ポリシーで CloudWatch Logs と S3バケットのアクセスを許可

両方の設定が揃って初めて、安全かつ正しくリソースにアクセスできます。

# Lambda × S3：バケットポリシーによるリソース側集中管理の設定手順

## ✅ ステップ 1：Lambda実行ロールの作成（例：LambdaThumbRole）

### 🔸 信頼ポリシー（Trust Policy）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
### 🔸 最小権限のIAMポリシー（ログ出力用）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}
```
このロールに付与するIAMポリシーは、CloudWatch Logsへの出力に必要な最小限の権限のみを持たせます。
※ S3アクセス権限はバケットポリシーで制御します。

## ✅ ステップ 2：S3バケット側にBucket Policyを設定

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowLambdaThumbRoleAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/LambdaThumbRole"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::my-image-bucket",
        "arn:aws:s3:::my-image-bucket/*"
      ]
    }
  ]
}
```
## ✅ ステップ 3（任意）：S3イベント通知でLambdaをトリガー

S3の「イベント通知」設定で、ObjectCreated イベント発生時に Lambda 関数をトリガーするよう設定します。
➡ ファイルがアップロードされたら自動的にLambdaが呼び出され、サムネイル生成を実行。



