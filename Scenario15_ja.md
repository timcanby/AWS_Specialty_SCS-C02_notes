
# AWS Organizations × IAM Identity Center（SSO）によるリージョン・サービス制限設計ドキュメント

---

## 📘 シナリオ

ある企業は、開発チームごとに AWS アカウントを分離し、**AWS Organizations** と **IAM Identity Center（旧 SSO）** を活用してマルチアカウント構成を設計中。  
要件は以下のとおり：

- 各開発チームは **使用可能な AWS リージョンを限定**する必要がある  
- 各アカウントでは **特定の AWS サービスのみを利用可能**にする必要がある  
- 管理者の **運用負荷を最小限に抑える**ことが重要

---

## ✅ 最適な対応策

### **C. サービスコントロールポリシー（SCP）により、リージョンおよびサービス制限を実施**

| 理由 | 説明 |
|------|------|
| ✅ 組織単位での制御が可能 | SCP は OU（組織単位）単位で制限を一元管理できるため、全アカウントに共通適用可能 |
| ✅ Identity Center や IAM ポリシーより上位の強制力 | IAM ポリシーやロール設定よりも優先され、**明示的にブロック**できる |
| ✅ リージョン・サービス両方に適用可能 | `Condition` や `NotAction` を使うことで、使用可能なサービスやリージョンを明確に制御可能 |
| ✅ スケーラブル | 新しいアカウントを OU に追加するだけで自動的に制限が適用される

---

## 🚫 他の選択肢の課題

| 選択肢 | 問題点 |
|--------|--------|
| A. Identity Center でのポリシー設定 | 各アカウント・各ロールごとに個別設定が必要になり、管理負荷が高い |
| B. STS のリージョン単位無効化 | 無効化は限定的で一部サービスにしか適用できず、全体的な制御としては不十分 |
| D. Identity Center 用のカスタム IAM ポリシーを各アカウントに設定 | アカウント数が増えると運用負荷が急増し、統一的な管理が難しい |

---

## 🧠 補足知識：SCP（サービスコントロールポリシー）による制限とその利点

### 🔐 SCP（Service Control Policy）とは？

SCP は AWS Organizations における **上位レベルのアクセスコントロールメカニズム** です。  
各アカウントにおける IAM ポリシーの上位で作用し、**「そのアカウントで許可できる最大のアクセス範囲」を定義**します。

### ✅ SCP の特長

| 特性 | 説明 |
|------|------|
| 強制力 | IAM ポリシーで明示的に許可されていても、SCP でブロックされていれば実行不可 |
| OU（組織単位）適用 | OU に SCP をアタッチすることで、配下のすべてのアカウントに適用 |
| 一元管理 | アカウントごとの細かな設定をせずに、共通ルールを集中制御できる |
| 安全性 | 誤設定による過剰権限付与のリスクを大幅に削減できる |
| 条件指定可能 | `Condition` を使ってリージョンやサービスなどでフィルタリング可能 |

---

## 🌍 リージョン制限の具体的な書き方（SCP 例）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowOnlySpecificRegions",
      "Effect": "Deny",
      "Action": "*",
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "aws:RequestedRegion": ["ap-northeast-1", "us-west-2"]
        }
      }
    }
  ]
}
```

このポリシーでは、`ap-northeast-1`（東京）と `us-west-2`（オレゴン）以外のリージョンでの全操作を拒否します。

---

## 🧰 IAM ポリシーや Identity Center による制御との違い

| 比較項目 | SCP | IAM ポリシー（Identity Center） |
|-----------|-----|-----------------------------|
| 管理単位 | OU 単位（組織全体） | アカウント × ユーザー/ロール単位 |
| スケーラビリティ | 非常に高い（OU追加で即時反映） | アカウント増加ごとに個別設定必要 |
| 制限方式 | 最大許可範囲の定義（Allow/Deny） | 明示的な許可操作（Allow）ベース |
| 適用範囲 | 全サービス・全 API を対象に適用可能 | IAM ポリシーで許可された範囲内のみ有効 |
| 利用の推奨範囲 | 組織全体の制限・ガバナンス | 特定ユーザー・ロールの権限定義に有効 |

---

## ✅ 推奨構成パターン

- **リージョンやサービス制限のような統一ルールは SCP で制御**
- **ユーザーごとのアクセス範囲は IAM Identity Center の権限セット（Permission Set）で管理**
- **2層構造（SCP + Identity Center）でセキュリティ強化と運用効率を両立**

## 📘 設定例

あなたは IT 開発会社に新しく入社したシステム管理者であり、**会社用の AWS アカウントを今日初めて作成したばかり**です。  
本ドキュメントでは、会社の AWS 利用を安全・効率的に開始するために、最初に行うべきステップを一つずつ例付きで解説します。

---

###✅ ステップ1：ルートユーザーの保護と初期設定

| 作業内容 | 説明 |
|----------|------|
| ルートユーザー MFA 有効化 | セキュリティ上必須。仮想 MFA アプリ（Google Authenticatorなど）で有効化 |
| ルートでの日常利用を避ける | ルートは緊急時専用。IAMユーザーや IAM Identity Center を使う |
| 連絡先情報と支払い情報の登録 | 「アカウント設定」から会社の正式情報を入力 |

---

### ✅ ステップ2：AWS Organizations を使ったマルチアカウント構成の導入

```bash
1. AWS Organizations にアクセス
2. 新しい組織を作成
3. 開発用、テスト用、本番用など用途別に AWS アカウントを作成
```

- OU（組織単位）を定義し、各用途に分ける（例：Dev, Test, Prod）

---

###✅ ステップ3：IAM Identity Center (旧 SSO) の設定

| 作業 | 例 |
|------|-----|
| Identity Center を有効化 | 管理アカウントから「IAM Identity Center」にアクセスし有効化 |
| グループとユーザーを作成 | "Developers", "Admins" グループを作成し、ユーザーを所属させる |
| アカウントと権限セットを紐づける | "Developers" は ReadOnly、"Admins" は AdministratorAccess 権限セットを割り当てる |

---

###✅ ステップ4：サービスコントロールポリシー (SCP) による制限

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Deny",
    "Action": "*",
    "Resource": "*",
    "Condition": {
      "StringNotEquals": {
        "aws:RequestedRegion": ["ap-northeast-1"]
      }
    }
  }]
}
```

- 東京リージョン以外の操作を拒否する例

---

## ✅ ステップ5：CloudTrail ＆ GuardDuty による監視の有効化

- CloudTrail → すべてのアカウントで有効化し、証跡をS3に保存
- GuardDuty → 各アカウントで有効化し、脅威検知ログを一括管理アカウントに集約

---

## ✅ ステップ6：コストと予算の制御

| ツール | 説明 |
|--------|------|
| AWS Budgets | 月額上限を設定し、超過しそうな時に通知 |
| Cost Explorer | サービス別・アカウント別のコスト確認 |
| 請求アラート | SNS + CloudWatch でしきい値通知設定

---

## ✅ ステップ7：ベストプラクティスとおすすめ設定

- IAM ポリシーは最小権限で設計
- アクセスキーの使用は避け、可能な限り IAM ロールや CLI+SSO を使用
- EC2 のデフォルト VPC を利用する前にネットワーク設計を見直す
- Tag（Name/Environment/Owner）をルール化してすべてのリソースに付ける

---

## 📌 まとめ：初期導入構成テンプレート

| 項目 | 推奨設定 |
|------|----------|
| アカウント構成 | Organizations + OU + Identity Center |
| アクセス管理 | IAM Identity Center + Permission Sets |
| 監査ログ | CloudTrail + GuardDuty |
| 制限ルール | SCP による統制（リージョン・サービス） |
| コスト管理 | Budgets + Cost Explorer |

---

この構成で、企業としてセキュリティ・可視性・運用性を確保した AWS 利用をスタートできます。

