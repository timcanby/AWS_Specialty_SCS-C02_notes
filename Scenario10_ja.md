
#  クロスアカウント S3 アクセス設計ドキュメント（Account A → Account B）

---

## 📘 Scenario（シナリオ）

- 企業 A（Account A）は、企業 B（Account B）を買収。
- Account B の S3 バケットに保存されたファイルに対して、Account A のユーザーにフルアクセスを与えたい。
- Account A 側の IAM ポリシーは設定済みだが、アクセスは拒否されている。

---

## 🧠 重要ポイント

| 項目 | 内容 |
|------|------|
| ✅ IAM ポリシーのみでは不十分 | IAM は「誰に何を許可するか」を定義するが、S3 バケット側の「受け入れ設定」が必要 |
| ✅ S3 のリソースベースポリシー | S3 バケット側で「どの外部アカウントのどのユーザーにアクセスを許可するか」を明示する必要がある |
| ✅ Principal と Resource の両方を明示 | 相互の ARN を明記し、双方向に権限が成立するように構成 |
| ❌ ACL は推奨されない | ACL（アクセスコントロールリスト）は細かい制御が難しく、現在は非推奨機能 |
| ❌ Account B 内の IAM ユーザーに対するポリシーは意味がない | Account A のユーザーには作用しない |

---

## ✅ 解決策：バケットポリシーによるクロスアカウント許可

### Account B に設定するバケットポリシー（例）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111122223333:user/TargetUser"
      },
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::example-bucket",
        "arn:aws:s3:::example-bucket/*"
      ]
    }
  ]
}
```

- `Principal`: アクセスを許可したいユーザーの ARN（Account A 側）
- `Resource`: 対象の S3 バケットとその中のオブジェクトすべて
- `Action`: どの操作を許可するか（例：`s3:GetObject`, `s3:PutObject`, `s3:*` など）

---

## 📘 関連知識：クロスアカウントアクセスを成立させる 2 つの条件

| 要件 | 説明 |
|------|------|
| ① アクセス元ユーザーの IAM ポリシー | Account A のユーザーに `s3:*` など適切な操作を許可 |
| ② バケット側のリソースベースポリシー | Account B の S3 バケットに外部ユーザーのアクセスを明示的に許可するバケットポリシー |

---

## 🚫 他の方法とその限界

| 方法 | 問題点 |
|------|--------|
| バケット ACL | 操作粒度が粗く、ユーザー指定が困難。監査性・管理性が低いため非推奨。 |
| オブジェクト ACL | 各オブジェクトごとに設定が必要。スケールしない。 |
| IAM ポリシー（Account B 側） | Account B の IAM ユーザーやロールにしか適用できないため、Account A のユーザーには効果がない。 |

---

## 🛡️ ベストプラクティス：S3 クロスアカウント設計のポイント

- **Resourceベースのバケットポリシーを使う**
- **ARN（アカウント番号 + ユーザー/ロール名）を明示的に書く**
- **最小権限の原則を守る（例：s3:GetObject のみ許可など）**
- **ログ記録の有効化（S3 Access Logs や CloudTrail）**

---

## ✅ 結論

- IAM ユーザー間のクロスアカウントアクセスには、**アクセス元の IAM ポリシーと、S3 バケット側のバケットポリシーの両方が必要**
- このような設計では、**Account B 側のバケットポリシーで明示的に許可を与えることが必須**
- よって、**正しい対応策は「選択肢 C：バケットポリシーの追加」**である

---


---

## 🧾 Account A 側の IAM ポリシー例（アクセス元ユーザーに付与）

Account A の IAM ユーザー（例: TargetUser）には、以下のような IAM ポリシーをアタッチする必要があります：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::example-bucket",
        "arn:aws:s3:::example-bucket/*"
      ]
    }
  ]
}
```

- `Action`：必要に応じて `s3:GetObject`, `s3:PutObject` などに制限可能
- `Resource`：Account B の S3 バケットの ARN を指定
- ※ Account A 側でこのポリシーが適用されていても、**Account B 側のバケットポリシーがないとアクセスは拒否される**点に注意

---

## 📝 補足：トラブルが発生したときの確認ポイント

1. バケットポリシーに指定された `Principal` が正しいか（ARN ミス）
2. IAM ポリシーとバケットポリシーの両方で必要な `Action` が許可されているか
3. S3 バケットに「バケットオーナー強制設定（ACL 無効化）」が有効になっていないか
4. アクセス拒否エラー発生時は IAM Policy Simulator や S3 アクセスアナライザーで検証

---
