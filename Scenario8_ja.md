
#  GuardDuty × インシデント自動封じ込め設計ドキュメント（RDPブルートフォース攻撃への対応）

---

## 📘 Scenario（シナリオ）

ある企業は **Amazon GuardDuty** を有効化しており、今後は検出された脅威に対して**自動的に一時的なブロック処理を行いたい**と考えています。

初期対応の対象は以下の通り：

- **Amazon EC2 インスタンスから発生する RDP（リモートデスクトップ）ブルートフォース攻撃**
- 攻撃元が自社環境内の EC2 インスタンスであることが前提
- そのインスタンスからの通信を一時的にブロックし、調査と復旧対応を行う時間を確保したい

---

## 🧠 重要ポイント

| 項目 | 内容 |
|------|------|
| ✅ GuardDuty の検出結果活用 | RDP brute force などの脅威は GuardDuty によりリアルタイムに検出される |
| ✅ 自動封じ込め | 検出イベントに応じて、自動的に通信をブロック（即時対応） |
| ✅ 一時的ブロックの方法 | セキュリティグループやネットワーク ACL、Network Firewall のルールで実施可能 |
| ✅ 人手による調査の余地を残す | 調査後に復旧できるよう、**遮断のみを目的**とした非破壊的な措置が望ましい |
| ✅ ネイティブサービス活用 | AWS のマネージドサービス（GuardDuty, EventBridge, Lambda, SNS など）を組み合わせて構成する |


---

## 🧩 RDP ブルートフォース攻撃とは？

- 「ブルートフォース攻撃（総当たり攻撃）」とは、ユーザー名やパスワードを特定するために、あらゆる組み合わせを自動的に繰り返し試行する攻撃手法です。
- RDP（Remote Desktop Protocol）は、Windows や一部の Linux サーバーにリモート接続するためのプロトコルであり、リモートワークや管理操作のために多くの環境で使用されています。
- よって「RDP ブルートフォース攻撃」とは、RDP ポート（通常は TCP 3389）を通じて、不正にリモートログインを試みるために、**無作為あるいはリスト化されたユーザー名・パスワードの組み合わせを何百回・何千回と試す攻撃**です。

---

### 🔎 具体例（技術的にどういう挙動になるか）

- 攻撃元の EC2 インスタンスから、**1秒あたり数十件のログイン試行**が外部または社内システムに向けて送信される。
- ユーザー名：「Administrator」「Admin」「root」「Guest」「test」などが連続的に試される。
- 実際には以下のような IP アドレス宛に大量の TCP 3389 ポート接続が観測される：
  - `203.0.113.10`、`203.0.113.11`、`198.51.100.22` など
- 一部の試行は成功し、不正な PowerShell スクリプトがリモートからダウンロードされる可能性もある。
- 攻撃元の EC2 インスタンスから、1秒あたり数回〜数十回のログイン要求がターゲットの IP アドレス（外部）に対して送られる。ユーザー名として「administrator」「admin」「user」「guest」などの一般的な名称が試行される。GuardDuty はこのような通信パターンを解析し、次のような Finding を生成します：

```json
{
  "type": "BruteForce:RDP/RemoteHost",
  "resource": {
    "instanceDetails": {
      "instanceId": "i-0123456789abcdef0",
      "tags": [...],
      "networkInterfaces": [...]
    }
  },
  "service": {
    "action": {
      "portProbeAction": {
        "portProbeDetails": [
          {
            "localPortDetails": {
              "port": 3389,
              "portName": "RDP"
            },
            "remoteIpDetails": {
              "ipAddressV4": "203.0.113.45",
              "organization": {
                "asn": 64512,
                "isp": "Suspicious ISP"
              }
            }
          }
        ]
      }
    }
  }
}
```

---

### 🧪 事例（AWS GuardDuty の検出に関するシナリオ）

1. **内部の開発者用 EC2 から外部ホストへの RDP 攻撃が検出された**
   - 影響：社内のベース AMI にマルウェアが含まれていた
   - 対応：インスタンスを隔離し、イメージを再作成

2. **踏み台ホストから別の VPC への RDP 試行が多数発生**
   - 影響：セキュリティグループの設定ミスにより、内部サブネットが開放されていた
   - 対応：SG を即時変更し、監査ログを収集

3. **Marketplace からデプロイされた Windows Server に不審な outbound RDP 通信が集中**
   - 影響：外部公開されたテスト用環境が攻撃ツールとして利用されていた
   - 対応：GuardDuty の自動封じ込め処理により通信遮断→調査報告

---

### ⚠️ なぜ危険なのか

- 一般的に EC2 インスタンスが攻撃元となっている場合、**意図しないアプリケーションの感染（マルウェアやボット化）**や**資格情報の流出による不正操作**が疑われます。
- このような攻撃が検出された場合、そのインスタンスを**即座にネットワークから隔離し、さらなる拡散や被害を防止することが極めて重要**です。
- 放置すれば **ブラックリスト登録、組織の信頼失墜、AWS アカウント停止のリスク** にも繋がります。

---


## ✅ 対応方法のまとめ（設計方針）

- GuardDuty の検出結果を **Amazon EventBridge** 経由で処理
- 該当インスタンスの **セキュリティグループを通信不可のものに置き換え**
- Lambda 関数でこの操作を自動化し、SNS で担当者へ通知
- 一時的な封じ込めとして有効、調査・復旧が容易

---

## 🚫 避けるべき方法（他の選択肢の注意点）

| 方法 | 理由 |
|------|------|
| A. Kinesis + ACL | Kinesis Data Analytics + ACL 変更は**複雑かつ過剰構成**。ACL は IP ベースであり、EC2 ID に対しては柔軟でない。 |
| B. AWS WAF | WAF は主に L7（HTTP/HTTPS）に適用され、**RDP（L4）通信には不適** |
| C. Network Firewall | 高度な制御は可能だが、**初期構築やコストが高い**。本件の要件（即時ブロック＋調査可能）には過剰。 |

---

## 🛠️ 実装例

### EventBridge + Lambda によるブロック処理の流れ

1. GuardDuty が `RDPBruteForce` の finding を生成  
2. EventBridge で該当タイプの finding を検知
3. Lambda 関数起動：
   - 該当インスタンスの現在のセキュリティグループを取得・保存
   - “全拒否”専用の SG に付け替え
4. SNS 通知により、対応チームに調査依頼を送信



---
## 🧭 AWS Security Hub とは？

**AWS Security Hub** は、複数の AWS セキュリティサービス（GuardDuty、Inspector、Macie、Firewall Manager など）やサードパーティ製のセキュリティツールの検出結果（Findings）を**統合的に収集・分析・可視化**できるセキュリティ統合管理サービスです。

### 🔍 主な特徴：

- **統合ビュー**：複数のアカウントやリージョンにまたがるセキュリティ状態を 1 つのダッシュボードで確認可能
- **標準準拠チェック**：CIS AWS Benchmark などのセキュリティ標準に基づいた診断結果を提供
- **EventBridge との連携**：検出された脅威に対して自動アクション（通知・封じ込めなど）を実行可能
- **Security Finding Format (ASFF)**：統一された JSON 構造により、複数サービスからの検出を一貫して処理

### 💡 使われるケース

- GuardDuty の findings を集約して可視化し、**優先度の高い脅威から調査対応**
- Security Hub findings を EventBridge 経由で Lambda に送信し、**自動封じ込め処理を実装**
- マルチアカウント環境でのセキュリティポスチャー（体制）を一元監視

---
---

## 🔍 攻撃をブロックした後に行うべき分析と対応

RDP ブルートフォース攻撃を GuardDuty により検出し、通信をブロックした後も、**攻撃の根本原因と影響範囲を正確に把握することが重要です**。以下のステップを踏むことで、再発防止やシステムの健全性維持につなげることができます。

### 🔬 1. インスタンスのフォレンジック分析（Forensic Analysis）

- **メモリダンプの取得**（Amazon EC2 メモリ取得ツールなど）
- **ディスクイメージのスナップショット**を作成し、別環境でマルウェアスキャンを実施
- **ログイン履歴やプロセス履歴の確認**（Windows の場合：Event Viewer、Linux の場合：auth.log、bash history）

### 🧾 2. CloudTrail および VPC Flow Logs の確認

- **誰がいつ何をしたか**を CloudTrail で確認
- 該当インスタンスの送受信トラフィックを **VPC Flow Logs** で解析し、不審な外部通信の有無を確認

### 📦 3. AMI/イメージのチェックと再構築

- 該当インスタンスが使っていたベース AMI やカスタムイメージを再点検
- マルウェアやバックドアが仕込まれていないか確認し、必要であれば AMI の更新と署名導入を検討

### 📘 4. GuardDuty Findings のトレンド監視と自動分類

- 類似する攻撃が他のインスタンスからも発生していないか継続監視
- **Security Hub を使って過去の攻撃とパターンを比較し、深刻度・優先順位を分類**

### 🛡️ 5. セキュリティポリシーと監視ルールの見直し

- **セキュリティグループやIAMポリシー**のルールを再評価し、必要な最小権限原則を適用
- GuardDuty / Security Hub / CloudWatch などの **検知ルールを強化**
- AWS Config や SCP（Service Control Policy）を使って、セキュリティ逸脱構成の自動検出を設定

